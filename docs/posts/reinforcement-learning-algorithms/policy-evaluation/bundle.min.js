var PolicyEvaluationFrozenLake=function(g){var a,b,c,f,d,e;this.DISPLAY={lowBackgroundColor:"#FFF",highBackgroundColor:"#5BADF0",lowTextColor:"#666",highTextColor:"#FFF",maxTimeStep:10},this.MODEL={p:[[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[0,0,0,0],[1,1,1,1],[0,0,0,0],[1,1,1,1],[1,1,1,1],[1,1,1,1],[0,0,0,0],[0,0,0,0],[1,1,1,1],[1,1,1,1],[0,0,0,0]],r:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],stateCount:16,simulate:function(b,c){var a=b;switch(c){case 0:a=b-4;break;case 1:a=b+1;break;case 2:a=b+4;break;case 3:a=b-1;break}return(a<0||a>=this.stateCount)&&(a=b),a}},this.theta=.01,this.gamma=.75,this.step=0,this.container=d3.select(g),a=this.container.append("div").classed("controls",!0),b=a.append("div").classed("policy-control",!0),b.append("button").attr("type","button").text("OPTIMAL").on("click",this.setOptimalPolicy.bind(this)),b.append("button").attr("type","button").text("EQUAL PROBABILITY").on("click",this.setEqualProbabilityPolicy.bind(this)),b.append("button").attr("type","button").text("RANDOM").on("click",this.setRandomPolicy.bind(this)),c=a.append("div").classed("time-step-control",!0),f=c.append("label").text("time step $t = $ "),this.timeStepValue=f.append("span").text(this.step),this.timeStepInput=c.append("input").attr("type","range").attr("min",0).attr("max",this.DISPLAY.maxTimeStep).property("value",this.step).on("input",this.setTimeStep.bind(this)),d=a.append("div").classed("gamma-control",!0),e=d.append("label").text("gamma $\\gamma =$ "),this.gammaValue=e.append("span").text(this.gamma),this.gammaInput=d.append("input").attr("type","range").attr("min",0).attr("max",1).attr("step",.05).property("value",this.gamma).on("input",this.setGamma.bind(this)),this.container.append("div").classed("frozen-lake-container",!0).append("div").classed("frozen-lake",!0),this.setOptimalPolicy()},PolicyEvaluation;PolicyEvaluationFrozenLake.prototype.run=function(){this.timer&&this.timer.stop(),this.step=-1,this.timer=d3.interval(this.incrementTimeStep.bind(this),150)},PolicyEvaluationFrozenLake.prototype.draw=function(){var a=this.container.select(".frozen-lake").selectAll("div.cell").data(this.valueFunction).join("div").classed("cell",!0),d=this,b=Math.min.apply(Math,this.valueFunction)||0,c=Math.max.apply(Math,this.valueFunction)||1,e=d3.scaleQuantize().domain([b,c]).range([d3.rgb(this.DISPLAY.lowTextColor),d3.rgb(this.DISPLAY.highTextColor)]),f=d3.scalePow().exponent(.5).interpolate(d3.interpolateHcl).domain([b,c]).range([d3.rgb(this.DISPLAY.lowBackgroundColor),d3.rgb(this.DISPLAY.highBackgroundColor)]);a.style("color",e).style("background-color",f),a.selectAll("i").data(this.getStatePolicy.bind(this)).join("i").attr("class",this.getMaterialIconClass).style("opacity",function(a){return a}).text(this.getMaterialIconText),a.selectAll("div.labels").data(function(a,b){return b===d.MODEL.stateCount-1?[]:[a]}).join("div").classed("labels",!0).classed("value",!0).text(function(a){return Number(a).toFixed(2)})},PolicyEvaluationFrozenLake.prototype.getStatePolicy=function(b,a){return this.policy[a]},PolicyEvaluationFrozenLake.prototype.getMaterialIconClass=function(c,a){var b=a%4;return["up","right","down","left"][b]+" material-icons"},PolicyEvaluationFrozenLake.prototype.getMaterialIconText=function(c,a){var b=a%4;return"arrow_"+["upward","forward","downward","back"][b]},PolicyEvaluationFrozenLake.prototype.setTimeStep=function(){this.step=Number(this.timeStepInput.property("value")),this.timeStepValue.text(this.step);var a=new PolicyEvaluation(this.MODEL,this.policy,this.theta,this.gamma,this.step);this.valueFunction=a.valueFunction,this.draw()},PolicyEvaluationFrozenLake.prototype.setGamma=function(){this.gamma=Number(this.gammaInput.property("value")),this.gammaValue.text(this.gamma);var a=new PolicyEvaluation(this.MODEL,this.policy,this.theta,this.gamma,this.step);this.valueFunction=a.valueFunction,this.draw()},PolicyEvaluationFrozenLake.prototype.incrementTimeStep=function(){this.timeStepInput.property("value",this.step+1),this.setTimeStep(),this.step>=this.DISPLAY.maxTimeStep&&this.timer.stop()},PolicyEvaluationFrozenLake.prototype.getOptimalPolicy=function(){return[[0,1,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1],[0,0,1,0],[0,0,0,0],[0,0,1,0],[0,0,0,0],[0,1,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,0],[0,0,0,0],[0,1,0,0],[0,1,0,0],[0,0,0,0]]},PolicyEvaluationFrozenLake.prototype.setOptimalPolicy=function(){this.policy=this.getOptimalPolicy(),this.run()},PolicyEvaluationFrozenLake.prototype.getEqualProbabilityPolicy=function(){for(var a=[],b=0,c,d;b<this.MODEL.stateCount-1;b++){c=[];for(d=0;d<4;d++)c.push(.25);a.push(c)}return a.push([0,0,0,0]),a},PolicyEvaluationFrozenLake.prototype.setEqualProbabilityPolicy=function(){this.policy=this.getEqualProbabilityPolicy(),this.run()},PolicyEvaluationFrozenLake.prototype.getRandomPolicy=function(){for(var b=[],c=0,a,d,e;c<this.MODEL.stateCount-1;c++){a=[];for(d=0;d<4;d++)a.push(Math.random());e=a.reduce(function(a,b){return a+b},0),a=a.map(function(a){return a/e}),b.push(a)}return b.push([0,0,0,0]),b},PolicyEvaluationFrozenLake.prototype.setRandomPolicy=function(){this.policy=this.getRandomPolicy(),this.run()},document.addEventListener("DOMContentLoaded",function(){new PolicyEvaluationFrozenLake(".policy-evaluation-frozen-lake")}),PolicyEvaluation=function(a,b,c,d,e){this.model=a,this.policy=b,this.theta=c,this.gamma=d,this.step=e,this.valueFunction=new Array(this.model.stateCount),this.initialize(),this.evaluatePolicy()},PolicyEvaluation.prototype.initialize=function(){for(var a=0;a<this.model.stateCount;a++)this.valueFunction[a]=0},PolicyEvaluation.prototype.evaluatePolicy=function(){var b,d=0,c,a,e;do{if(d++>=this.step)break;b=0,c=new Array(this.model.stateCount);for(a=0;a<this.model.stateCount;a++)e=this.valueFunction[a],c[a]=this.evaluateStateValue(a),b=Math.max(b,Math.abs(e-c[a]));this.valueFunction=c}while(b>this.theta)},PolicyEvaluation.prototype.evaluateStateValue=function(b){for(var c=0,a=0,d,e,f;a<4;a++)d=0,e=this.model.simulate(b,a),f=this.model.r[e],d+=this.model.p[b][a]*(f+this.gamma*this.valueFunction[e]),c+=this.policy[b][a]*d;return c}