var PolicyIterationFrozenLake=function(d){var b,a,c;this.DISPLAY={lowBackgroundColor:"#FFF",highBackgroundColor:"#5BADF0",lowTextColor:"#666",highTextColor:"#FFF",maxTimeStep:10},this.MODEL={p:[[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[0,0,0,0],[1,1,1,1],[0,0,0,0],[1,1,1,1],[1,1,1,1],[1,1,1,1],[0,0,0,0],[0,0,0,0],[1,1,1,1],[1,1,1,1],[0,0,0,0]],r:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],stateCount:16,simulate:function(b,c){var a=b;switch(c){case 0:a=b-4;break;case 1:a=b+1;break;case 2:a=b+4;break;case 3:a=b-1;break}return(a<0||a>=this.stateCount)&&(a=b),a}},this.theta=.01,this.gamma=.5,this.step=0,this.container=d3.select(d),b=this.container.append("div").classed("controls",!0),a=b.append("div").classed("time-step-control",!0),c=a.append("label").text("time step $t = $ "),this.timeStepValue=c.append("span").text(this.step),this.timeStepInput=a.append("input").attr("type","range").attr("min",0).attr("max",this.DISPLAY.maxTimeStep).property("value",this.step).on("input",this.setTimeStep.bind(this)),this.container.append("div").classed("frozen-lake-container",!0).append("div").classed("frozen-lake",!0),this.setEqualProbabilityPolicy(),this.run()},PolicyIteration;PolicyIterationFrozenLake.prototype.run=function(){this.timer&&this.timer.stop(),this.timer=d3.interval(this.incrementTimeStep.bind(this),150)},PolicyIterationFrozenLake.prototype.draw=function(){var a=this.container.select(".frozen-lake").selectAll("div.cell").data(this.valueFunction).join("div").classed("cell",!0),b=Math.min.apply(Math,this.valueFunction)||0,c=Math.max.apply(Math,this.valueFunction)||1,d=d3.scaleQuantize().domain([b,c]).range([d3.rgb(this.DISPLAY.lowTextColor),d3.rgb(this.DISPLAY.highTextColor)]),e=d3.scalePow().exponent(.5).interpolate(d3.interpolateHcl).domain([b,c]).range([d3.rgb(this.DISPLAY.lowBackgroundColor),d3.rgb(this.DISPLAY.highBackgroundColor)]);a.style("color",d).style("background-color",e),a.selectAll("i").data(this.getStatePolicy.bind(this)).join("i").attr("class",this.getMaterialIconClass).style("opacity",function(a){return a===0?0:.25+a}).text(this.getMaterialIconText),a.selectAll("div.labels").data(function(a){return[a]}).join("div").classed("labels",!0).classed("value",!0).text(function(a){return Number(a).toFixed(2)})},PolicyIterationFrozenLake.prototype.getStatePolicy=function(b,a){return this.policy[a]},PolicyIterationFrozenLake.prototype.getMaterialIconClass=function(c,a){var b=a%4;return["up","right","down","left"][b]+" material-icons"},PolicyIterationFrozenLake.prototype.getMaterialIconText=function(c,a){var b=a%4;return"arrow_"+["upward","forward","downward","back"][b]},PolicyIterationFrozenLake.prototype.setTimeStep=function(){this.step=Number(this.timeStepInput.property("value")),this.timeStepValue.text(this.step),this.setEqualProbabilityPolicy();var a=new PolicyIteration(this.MODEL,this.policy,this.theta,this.gamma,this.step);this.policy=a.policy,this.valueFunction=a.valueFunction,this.draw()},PolicyIterationFrozenLake.prototype.incrementTimeStep=function(){this.timeStepInput.property("value",this.step+1),this.setTimeStep(),this.step>=this.DISPLAY.maxTimeStep&&this.timer.stop()},PolicyIterationFrozenLake.prototype.setEqualProbabilityPolicy=function(){var a,b,c;this.policy=[];for(a=0;a<this.MODEL.stateCount-1;a++)if([5,7,11,12].indexOf(a)!==-1)this.policy.push([0,0,0,0]);else{b=[];for(c=0;c<4;c++)b.push(.25);this.policy.push(b)}this.policy.push([0,0,0,0])},document.addEventListener("DOMContentLoaded",function(){new PolicyIterationFrozenLake(".policy-iteration-frozen-lake")}),PolicyIteration=function(a,b,c,d,e){this.model=a,this.policy=b,this.theta=c,this.gamma=d,this.step=e,this.valueFunction=new Array(this.model.stateCount),this.initialize(),this.iteratePolicy()},PolicyIteration.prototype.initialize=function(){for(var a=0;a<this.model.stateCount;a++)this.valueFunction[a]=0},PolicyIteration.prototype.iteratePolicy=function(){for(var b=this.step,a=0;a<b;a++)this.step=a,this.step%2===0?this.evaluatePolicy():this.improvePolicy()},PolicyIteration.prototype.evaluatePolicy=function(){var b,d=0,c,a,e;do{if(d++>this.step/2)break;b=0,c=new Array(this.model.stateCount);for(a=0;a<this.model.stateCount;a++)e=this.valueFunction[a],c[a]=this.evaluateStateValue(a),b=Math.max(b,Math.abs(e-c[a]));this.valueFunction=c}while(b>this.theta)},PolicyIteration.prototype.evaluateStateValue=function(b){for(var c=0,a=0,d,e,f;a<4;a++)d=0,e=this.model.simulate(b,a),f=this.model.r[e],d+=this.model.p[b][a]*(f+this.gamma*this.valueFunction[e]),c+=this.policy[b][a]*d;return c},PolicyIteration.prototype.improvePolicy=function(){var b,a,c;if(this.step<=0)return;b=!0;for(a=0;a<this.model.stateCount-1;a++)c=this.policy[a],this.policy[a]=this.greedyPolicy(a),c!==this.policy[a]&&(b=!1);return b},PolicyIteration.prototype.greedyPolicy=function(b){var a,c,d,e;if([5,7,11,12].indexOf(b)!==-1)return[0,0,0,0];c=new Array(4);for(a=0;a<4;a++)d=this.model.simulate(b,a),e=this.model.r[d],c[a]=this.model.p[b][a]*(e+this.gamma*this.valueFunction[d]);return this.normalize(this.argMax(c))},PolicyIteration.prototype.argMax=function(a){var b=Math.max.apply(Math,a);return a.map(function(a){return Number(a===b)})},PolicyIteration.prototype.normalize=function(a){var b=a.reduce(function(a,b){return a+b});return a.map(function(a){return a/b})}